name: Build aarch64 DevCore for Raspberry Pi

on:
  push:
    tags:
      - 'r8.2.2'
      - 'r8.2.2-*'
    branches:
      - 'r8.2.2'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release after successful build'
        required: false
        default: 'true'
        type: boolean

env:
  MONGODB_VERSION: r8.2.2

jobs:
  build-aarch64:
    name: Build MongoDB DevCore for ARM64/aarch64
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: r8.2.2
          fetch-depth: 0
      
      - name: Set up QEMU for cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build MongoDB DevCore in ARM64 container
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            ubuntu:22.04 \
            bash -c '
              set -e
              
              # Update and install dependencies
              apt-get update
              apt-get install -y \
                build-essential \
                python3 \
                python3-pip \
                libcurl4-openssl-dev \
                liblzma-dev \
                git \
                wget \
                curl
              
              # Install Bazel
              python3 /workspace/buildscripts/install_bazel.py
              export PATH=~/.local/bin:$PATH
              
              # Create custom bazelrc for Raspberry Pi optimizations
              cat > .bazelrc.raspberrypi << EOF
          # Raspberry Pi specific compilation flags
          build --copt=-march=armv8-a+crc
          build --copt=-moutline-atomics
          build --copt=-mtune=cortex-a72
          EOF
              
              # Build DevCore with Raspberry Pi flags
              bazel build \
                --config=opt \
                --//bazel/config:compiler_type=gcc \
                --//bazel/config:linkstatic=True \
                --bazelrc=.bazelrc.raspberrypi \
                archive-devcore
              
              # Create output directory
              mkdir -p /workspace/artifacts
              
              # Copy the built archive
              cp bazel-bin/archive-devcore.tar.gz /workspace/artifacts/mongodb-devcore-${MONGODB_VERSION}-aarch64-raspberrypi.tar.gz
              
              # Generate checksums
              cd /workspace/artifacts
              sha256sum mongodb-devcore-${MONGODB_VERSION}-aarch64-raspberrypi.tar.gz > mongodb-devcore-${MONGODB_VERSION}-aarch64-raspberrypi.tar.gz.sha256
            '
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mongodb-devcore-aarch64-raspberrypi
          path: artifacts/*
          retention-days: 30
      
      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/r8.2.2') || (github.event_name == 'workflow_dispatch' && inputs.create_release == 'true')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: MongoDB DevCore ${{ github.ref_name }} - ARM64 for Raspberry Pi
          body: |
            # MongoDB DevCore ARM64 Build for Raspberry Pi
            
            This release contains MongoDB DevCore binaries compiled specifically for Raspberry Pi (ARM64/aarch64).
            
            ## Components Included
            - mongod (database server)
            - mongos (sharding router)
            - mongo shell (jstestshell)
            
            ## Compilation Flags
            These binaries were compiled with the following Raspberry Pi optimizations:
            - `-march=armv8-a+crc` - ARMv8-A architecture with CRC extensions
            - `-moutline-atomics` - Optimized atomic operations
            - `-mtune=cortex-a72` - Tuned for Cortex-A72 (Raspberry Pi 4/5)
            
            ## Installation
            ```bash
            # Download and extract
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mongodb-devcore-${{ env.MONGODB_VERSION }}-aarch64-raspberrypi.tar.gz
            tar -xzf mongodb-devcore-${{ env.MONGODB_VERSION }}-aarch64-raspberrypi.tar.gz
            
            # Run MongoDB
            cd mongodb-devcore-${{ env.MONGODB_VERSION }}-aarch64-raspberrypi/bin
            ./mongod --version
            ```
            
            ## Verification
            Verify the download using the provided SHA256 checksum.
          files: |
            artifacts/*.tar.gz
            artifacts/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
